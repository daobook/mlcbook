
<!DOCTYPE html>

<html lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>MLC ä½œä¸š 1: ç«¯åˆ°ç«¯æ¨¡å‹æ‰§è¡Œ &#8212; MLC 0.1 æ–‡æ¡£</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/default.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/tabs.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script kind="utterances">

    var commentsRunWhenDOMLoaded = cb => {
    if (document.readyState != 'loading') {
        cb()
    } else if (document.addEventListener) {
        document.addEventListener('DOMContentLoaded', cb)
    } else {
        document.attachEvent('onreadystatechange', function() {
        if (document.readyState == 'complete') cb()
        })
    }
}

var addUtterances = () => {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://utteranc.es/client.js";
    script.async = "async";

    script.setAttribute("repo", "daobook/mlcbook");
    script.setAttribute("issue-term", "pathname");
    script.setAttribute("theme", "github-light");
    script.setAttribute("label", "ğŸ’¬ comment");
    script.setAttribute("crossorigin", "anonymous");

    sections = document.querySelectorAll("div.section");
    if (sections !== null) {
        section = sections[sections.length-1];
        section.appendChild(script);
    }
}
commentsRunWhenDOMLoaded(addUtterances);
</script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script src="../_static/translations.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <link rel="canonical" href="https://daobook.github.io/mlcbook/assignment/assignment1.html" />
    <link rel="index" title="ç´¢å¼•" href="../genindex.html" />
    <link rel="search" title="æœç´¢" href="../search.html" />
    <link rel="prev" title="ç´¢å¼•å’Œè¡¨æ ¼" href="index.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="zh_CN">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../2_tensor_program_abstraction.html">
   å¼ é‡ç¨‹åºæŠ½è±¡
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../3_TensorIR_Tensor_Program_Abstraction_Case_Study_Action.html">
   å¼ é‡ç¨‹åºæŠ½è±¡çš„å­¦ä¹ æ¡ˆä¾‹ï¼šTensorIR
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../4_Build_End_to_End_Model.html">
   Ep4: End to End Model Execution
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../5_Automatic_Program_Optimization.html">
   Ep5: Automatic Program Optimization
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   MLC ä½œä¸š 1: ç«¯åˆ°ç«¯æ¨¡å‹æ‰§è¡Œ
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="index.html">
   ç´¢å¼•å’Œè¡¨æ ¼
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            <div>
ç‰ˆæƒæ‰€æœ‰Â Â©Â 2022 <a href="https://daobook.github.io/mlcbook">MLC</a>
</div>

            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/daobook/mlcbook/xin?urlpath=lab/tree/doc/assignment/assignment1.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://colab.research.google.com/github/daobook/mlcbook/blob/xin/doc/assignment/assignment1.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
      <li>
        
<button onclick="initThebeSBT()"
  class="headerbtn headerbtn-launch-thebe"
  data-toggle="tooltip"
data-placement="left"
title="Launch Thebe"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="headerbtn__text-container">Live Code</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/daobook/mlcbook"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/daobook/mlcbook/issues/new?title=Issue%20on%20page%20%2Fassignment/assignment1.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/daobook/mlcbook/edit/xin/doc/assignment/assignment1.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/assignment/assignment1.ipynb.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> å¯¼èˆª
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   ç¬¬ä¸€éƒ¨åˆ†: æ¨¡å‹å‡†å¤‡
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pytorch">
   ç¬¬äºŒéƒ¨åˆ†: ä»PyTorchè¿ç§»æ¨¡å‹
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id2">
   ç¬¬ä¸‰éƒ¨åˆ†: ä½¿ç”¨åº“
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id3">
   ç¬¬å››éƒ¨åˆ†: ç«¯åˆ°ç«¯æ¨¡å‹ä¸­çš„ç¨‹åºå˜æ¢
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>MLC ä½œä¸š 1: ç«¯åˆ°ç«¯æ¨¡å‹æ‰§è¡Œ</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> å¯¼èˆª </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   ç¬¬ä¸€éƒ¨åˆ†: æ¨¡å‹å‡†å¤‡
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pytorch">
   ç¬¬äºŒéƒ¨åˆ†: ä»PyTorchè¿ç§»æ¨¡å‹
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id2">
   ç¬¬ä¸‰éƒ¨åˆ†: ä½¿ç”¨åº“
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id3">
   ç¬¬å››éƒ¨åˆ†: ç«¯åˆ°ç«¯æ¨¡å‹ä¸­çš„ç¨‹åºå˜æ¢
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="mlc-1">
<h1>MLC ä½œä¸š 1: ç«¯åˆ°ç«¯æ¨¡å‹æ‰§è¡Œ<a class="headerlink" href="#mlc-1" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h1>
<section id="id1">
<h2>ç¬¬ä¸€éƒ¨åˆ†: æ¨¡å‹å‡†å¤‡<a class="headerlink" href="#id1" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h2>
<p>æœ¬ä½œä¸šçš„ç›®æ ‡æ˜¯è®©ä½ å¯¹æœºå™¨å­¦ä¹ ç¼–è¯‘è¿‡ç¨‹ä¸­çš„ç«¯åˆ°ç«¯æ¨¡å‹çš„æ‰§è¡Œå’Œå˜æ¢æ›´åŠ ç†Ÿæ‚‰ã€‚è®©æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„å›¾åƒåˆ†ç±»æ¨¡å‹å¼€å§‹ã€‚</p>
<p>æˆ‘ä»¬é¦–å…ˆä½¿ç”¨å¦‚ä¸‹çš„å‘½ä»¤æ¥å®‰è£…å¿…è¦çš„åº“ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python3 -m pip install mlc-ai-nightly -f https://mlc.ai/wheels
<span class="o">!</span>python3 -m pip install torch torchvision torchaudio torchsummary --extra-index-url https://download.pytorch.org/whl/cpu
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Looking in links: https://mlc.ai/wheels
Requirement already satisfied: mlc-ai-nightly in /media/pc/data/4tb/lxw/anaconda3/envs/mlc/lib/python3.10/site-packages (0.9.dev1664+g1f3985de0)
Requirement already satisfied: psutil in /media/pc/data/4tb/lxw/anaconda3/envs/mlc/lib/python3.10/site-packages (from mlc-ai-nightly) (5.9.1)
Requirement already satisfied: scipy in /media/pc/data/4tb/lxw/anaconda3/envs/mlc/lib/python3.10/site-packages (from mlc-ai-nightly) (1.8.1)
Requirement already satisfied: synr==0.6.0 in /media/pc/data/4tb/lxw/anaconda3/envs/mlc/lib/python3.10/site-packages (from mlc-ai-nightly) (0.6.0)
Requirement already satisfied: tornado in /media/pc/data/4tb/lxw/anaconda3/envs/mlc/lib/python3.10/site-packages (from mlc-ai-nightly) (6.1)
Requirement already satisfied: decorator in /media/pc/data/4tb/lxw/anaconda3/envs/mlc/lib/python3.10/site-packages (from mlc-ai-nightly) (5.1.1)
Requirement already satisfied: attrs in /media/pc/data/4tb/lxw/anaconda3/envs/mlc/lib/python3.10/site-packages (from mlc-ai-nightly) (21.4.0)
Requirement already satisfied: numpy in /media/pc/data/4tb/lxw/anaconda3/envs/mlc/lib/python3.10/site-packages (from mlc-ai-nightly) (1.23.1)
Requirement already satisfied: cloudpickle in /media/pc/data/4tb/lxw/anaconda3/envs/mlc/lib/python3.10/site-packages (from mlc-ai-nightly) (2.1.0)
Looking in indexes: https://pypi.org/simple, https://download.pytorch.org/whl/cpu
Collecting torch
  Downloading https://download.pytorch.org/whl/cpu/torch-1.12.0%2Bcpu-cp310-cp310-linux_x86_64.whl (189.0 MB)
     â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” <span class=" -Color -Color-Green">189.0/189.0 MB</span> <span class=" -Color -Color-Red">4.3 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>00:0100:01
?25hCollecting torchvision
  Downloading https://download.pytorch.org/whl/cpu/torchvision-0.13.0%2Bcpu-cp310-cp310-linux_x86_64.whl (13.5 MB)
     â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” <span class=" -Color -Color-Green">13.5/13.5 MB</span> <span class=" -Color -Color-Red">8.8 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>00:0100:01m
?25hCollecting torchaudio
  Downloading https://download.pytorch.org/whl/cpu/torchaudio-0.12.0%2Bcpu-cp310-cp310-linux_x86_64.whl (3.5 MB)
     â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” <span class=" -Color -Color-Green">3.5/3.5 MB</span> <span class=" -Color -Color-Red">15.3 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>00:0100:01
?25hCollecting torchsummary
  Using cached torchsummary-1.5.1-py3-none-any.whl (2.8 kB)
Requirement already satisfied: typing-extensions in /media/pc/data/4tb/lxw/anaconda3/envs/mlc/lib/python3.10/site-packages (from torch) (4.3.0)
Requirement already satisfied: numpy in /media/pc/data/4tb/lxw/anaconda3/envs/mlc/lib/python3.10/site-packages (from torchvision) (1.23.1)
Requirement already satisfied: requests in /media/pc/data/4tb/lxw/anaconda3/envs/mlc/lib/python3.10/site-packages (from torchvision) (2.28.1)
Requirement already satisfied: pillow!=8.3.*,&gt;=5.3.0 in /media/pc/data/4tb/lxw/anaconda3/envs/mlc/lib/python3.10/site-packages (from torchvision) (9.2.0)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /media/pc/data/4tb/lxw/anaconda3/envs/mlc/lib/python3.10/site-packages (from requests-&gt;torchvision) (3.3)
Requirement already satisfied: certifi&gt;=2017.4.17 in /media/pc/data/4tb/lxw/anaconda3/envs/mlc/lib/python3.10/site-packages (from requests-&gt;torchvision) (2022.6.15)
Requirement already satisfied: charset-normalizer&lt;3,&gt;=2 in /media/pc/data/4tb/lxw/anaconda3/envs/mlc/lib/python3.10/site-packages (from requests-&gt;torchvision) (2.1.0)
Requirement already satisfied: urllib3&lt;1.27,&gt;=1.21.1 in /media/pc/data/4tb/lxw/anaconda3/envs/mlc/lib/python3.10/site-packages (from requests-&gt;torchvision) (1.26.10)
Installing collected packages: torchsummary, torch, torchvision, torchaudio
Successfully installed torch-1.12.0+cpu torchaudio-0.12.0+cpu torchsummary-1.5.1 torchvision-0.13.0+cpu
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pickle</span> <span class="k">as</span> <span class="nn">pkl</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">import</span> <span class="nn">tvm</span>
<span class="kn">import</span> <span class="nn">tvm.testing</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<span class="kn">from</span> <span class="nn">tvm</span> <span class="kn">import</span> <span class="n">topi</span><span class="p">,</span> <span class="n">relax</span><span class="p">,</span> <span class="n">te</span>
<span class="kn">from</span> <span class="nn">tvm.script</span> <span class="kn">import</span> <span class="n">tir</span> <span class="k">as</span> <span class="n">T</span>
</pre></div>
</div>
</div>
</div>
<p>ä»¥ä¸‹æ˜¯ç”¨PyTorchå®šä¹‰çš„æ¨¡å‹ã€‚è¯¥æ¨¡å‹æ¥å—ä¸€æ‰¹å›¾åƒä¸ºè¾“å…¥ï¼Œç„¶åå¯¹å®ƒä»¬ä¾æ¬¡ä½œç”¨å·ç§¯å±‚ï¼Œæ¿€æ´»å±‚ï¼Œæ± åŒ–å±‚å’Œå…¨è¿æ¥å±‚ï¼Œå¾—åˆ°åˆ†ç±»ç»“æœã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>  <span class="c1"># NCHW layout</span>


<span class="k">def</span> <span class="nf">pytorch_model</span><span class="p">():</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="nb">list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
    <span class="nb">list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
    <span class="nb">list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Flatten</span><span class="p">())</span>
    <span class="nb">list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">5408</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="nb">list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
    <span class="nb">list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="nb">list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="n">name_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;0.weight&quot;</span><span class="p">:</span> <span class="s2">&quot;conv2d_weight&quot;</span><span class="p">,</span>
        <span class="s2">&quot;0.bias&quot;</span><span class="p">:</span> <span class="s2">&quot;conv2d_bias&quot;</span><span class="p">,</span>
        <span class="s2">&quot;4.weight&quot;</span><span class="p">:</span> <span class="s2">&quot;linear0_weight&quot;</span><span class="p">,</span>
        <span class="s2">&quot;4.bias&quot;</span><span class="p">:</span> <span class="s2">&quot;linear0_bias&quot;</span><span class="p">,</span>
        <span class="s2">&quot;6.weight&quot;</span><span class="p">:</span> <span class="s2">&quot;linear1_weight&quot;</span><span class="p">,</span>
        <span class="s2">&quot;6.bias&quot;</span><span class="p">:</span> <span class="s2">&quot;linear1_bias&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
        <span class="n">param</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">weight_map</span><span class="p">[</span><span class="n">name_map</span><span class="p">[</span><span class="n">name</span><span class="p">]])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<p>æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªåœ¨Fashion MNISTæ•°æ®é›†ä¸Šçš„é¢„è®­ç»ƒæƒé‡å›¾ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Hide outputs</span>
<span class="o">!</span>wget -nc https://github.com/mlc-ai/web-data/raw/main/models/fasionmnist_mlp_assignment_params.pkl
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--2022-07-24 23:46:45--  https://github.com/mlc-ai/web-data/raw/main/models/fasionmnist_mlp_assignment_params.pkl
Resolving github.com (github.com)... 20.205.243.166
Connecting to github.com (github.com)|20.205.243.166|:443... connected.
HTTP request sent, awaiting response... 302 Found
Location: https://raw.githubusercontent.com/mlc-ai/web-data/main/models/fasionmnist_mlp_assignment_params.pkl [following]
--2022-07-24 23:46:46--  https://raw.githubusercontent.com/mlc-ai/web-data/main/models/fasionmnist_mlp_assignment_params.pkl
Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 185.199.108.133, 185.199.109.133, 185.199.110.133, ...
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|185.199.108.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 2169350 (2.1M) [application/octet-stream]
Saving to: â€˜fasionmnist_mlp_assignment_params.pklâ€™

fasionmnist_mlp_ass 100%[===================&gt;]   2.07M  5.21MB/s    in 0.4s    

2022-07-24 23:46:48 (5.21 MB/s) - â€˜fasionmnist_mlp_assignment_params.pklâ€™ saved [2169350/2169350]
</pre></div>
</div>
</div>
</div>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒçš„å‡†ç¡®ç‡çº¦ä¸º84%ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the weight map from file.</span>
<span class="c1"># The prediction accuracy of the weight map on test data is around 83.3%.</span>
<span class="n">weight_map</span> <span class="o">=</span> <span class="n">pkl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;fasionmnist_mlp_assignment_params.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>
<span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;T-shirt/top&#39;</span><span class="p">,</span> <span class="s1">&#39;Trouser&#39;</span><span class="p">,</span> <span class="s1">&#39;Pullover&#39;</span><span class="p">,</span> <span class="s1">&#39;Dress&#39;</span><span class="p">,</span> <span class="s1">&#39;Coat&#39;</span><span class="p">,</span>
               <span class="s1">&#39;Sandal&#39;</span><span class="p">,</span> <span class="s1">&#39;Shirt&#39;</span><span class="p">,</span> <span class="s1">&#39;Sneaker&#39;</span><span class="p">,</span> <span class="s1">&#39;Bag&#39;</span><span class="p">,</span> <span class="s1">&#39;Ankle boot&#39;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">test_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">print_img</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">test_loader</span><span class="p">:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">label</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># sum up batch loss</span>
            <span class="n">test_loss</span> <span class="o">+=</span> <span class="n">F</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="c1"># get the index of the max log-probability</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">print_img</span><span class="p">:</span>
                <span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;predict: </span><span class="si">{}</span><span class="s2">, label: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">class_names</span><span class="p">[</span><span class="n">pred</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span> <span class="n">class_names</span><span class="p">[</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
                <span class="n">print_img</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">correct</span> <span class="o">+=</span> <span class="n">pred</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">pred</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

    <span class="n">test_loss</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Test set: Average loss: </span><span class="si">{:.4f}</span><span class="s2">, Accuracy: </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{:.0f}</span><span class="s2">%)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">test_loss</span><span class="p">,</span> <span class="n">correct</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">),</span>
        <span class="mf">100.</span> <span class="o">*</span> <span class="n">correct</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span>
    <span class="n">npimg</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">npimg</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">test_data</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">FashionMNIST</span><span class="p">(</span>
    <span class="s2">&quot;./data&quot;</span><span class="p">,</span>
    <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()])</span>
<span class="p">)</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">test_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">test</span><span class="p">(</span><span class="n">pytorch_model</span><span class="p">(),</span> <span class="n">test_loader</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/train-images-idx3-ubyte.gz
Downloading http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/train-images-idx3-ubyte.gz to ./data/FashionMNIST/raw/train-images-idx3-ubyte.gz
Extracting ./data/FashionMNIST/raw/train-images-idx3-ubyte.gz to ./data/FashionMNIST/raw

Downloading http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/train-labels-idx1-ubyte.gz
Downloading http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/train-labels-idx1-ubyte.gz to ./data/FashionMNIST/raw/train-labels-idx1-ubyte.gz
Extracting ./data/FashionMNIST/raw/train-labels-idx1-ubyte.gz to ./data/FashionMNIST/raw

Downloading http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/t10k-images-idx3-ubyte.gz
Downloading http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/t10k-images-idx3-ubyte.gz to ./data/FashionMNIST/raw/t10k-images-idx3-ubyte.gz
Extracting ./data/FashionMNIST/raw/t10k-images-idx3-ubyte.gz to ./data/FashionMNIST/raw

Downloading http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/t10k-labels-idx1-ubyte.gz
Downloading http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/t10k-labels-idx1-ubyte.gz to ./data/FashionMNIST/raw/t10k-labels-idx1-ubyte.gz
Extracting ./data/FashionMNIST/raw/t10k-labels-idx1-ubyte.gz to ./data/FashionMNIST/raw

predict: Ankle boot, label: Ankle boot

Test set: Average loss: -0.8369, Accuracy: 8388/10000 (84%)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100.0%
100.0%
100.0%
100.0%
</pre></div>
</div>
<img alt="../_images/4363cf464ac87db604eb77d05e1d3e371f9618f203ed6a32572e9cd8e41ca558.png" src="../_images/4363cf464ac87db604eb77d05e1d3e371f9618f203ed6a32572e9cd8e41ca558.png" />
</div>
</div>
</section>
<section id="pytorch">
<h2>ç¬¬äºŒéƒ¨åˆ†: ä»PyTorchè¿ç§»æ¨¡å‹<a class="headerlink" href="#pytorch" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h2>
<p>ä¸ºäº†å±•ç¤ºæœºå™¨å­¦ä¹ ç¼–è¯‘å¯¹ç«¯åˆ°ç«¯æ¨¡å‹çš„æŠ½è±¡ï¼Œæˆ‘ä»¬éœ€è¦å°†æ¨¡å‹ä»PyTorchè¿ç§»å¹¶è½¬æ¢ä¸ºTVMScriptå®ç°ã€‚ç„¶åï¼Œæ‰‹å·¥è¿ç§»å¾ˆéš¾ã€‚æ­£å¦‚ä½ åœ¨TensorIRç»ƒä¹ ä¸­æ‰€ä½“éªŒçš„é‚£æ ·ï¼Œä¸ºæ¨¡å‹ä¸­çš„æ¯ä¸€å±‚å†™ä¸€ä¸ªå…ƒå¼ é‡å‡½æ•°éœ€è¦å¤§é‡çš„äººåŠ›æ¥å®Œæˆã€‚å¦å¤–ï¼Œæ‰‹å·¥å†™è¿™äº›å‡½æ•°æ˜¯å®¹æ˜“çŠ¯é”™çš„ã€‚ä½ å¯ä»¥æƒ³è±¡ï¼Œå½“ä½ å†™äº†å‡ ç™¾è¡Œï¼Œä½†å…¶ä¸­æœ‰é›¶æ˜Ÿå‡ ä¸ªbugï¼Œé‚£ä¹ˆæ‰¾åˆ°bugçš„è¿‡ç¨‹å°†ä¼šæ˜¯ç—›è‹¦çš„ã€‚</p>
<p>å¹¸è¿çš„æ˜¯ï¼Œåœ¨TVMä¸­æœ‰ä¸€ä¸ªç®€å•çš„å¤šçš„æ–¹æ³•èƒ½å¤Ÿè¿ç§»æ¨¡å‹ã€‚TVMæä¾›äº†ä¸€ä¸ªç±»<code class="docutils literal notranslate"><span class="pre">relax.BlockBuilder</span></code>ï¼Œå®ƒèƒ½å¤Ÿä»ç©ºç™½çš„IRModuleå¼€å§‹ä¸€æ­¥æ­¥çš„æ„å»ºç«¯åˆ°ç«¯æ¨¡å‹ã€‚ï¼ˆå›å¿†æˆ‘ä»¬åœ¨ç¬¬å››èŠ‚è¯¾ä¸­ä»‹ç»çš„Relaxçš„Dataflow Blockï¼Œè¿™é‡Œçš„â€blockâ€å°±æ˜¯ä»£è¡¨äº†Relaxå‡½æ•°ä¸­çš„Dataflow Blockï¼‰</p>
<p>å…·ä½“è€Œè¨€ï¼Œåœ¨ <code class="docutils literal notranslate"><span class="pre">BlockBuilder</span></code>ä¸­æˆ‘ä»¬æœ‰ä¸€ä¸ª <code class="docutils literal notranslate"><span class="pre">emit_te</span></code>çš„APIï¼Œå®ƒå¯ä»¥å°†ä¸€ä¸ªå¼ é‡è¡¨è¾¾å¼ï¼ˆç¬¬ä¸‰èŠ‚è¯¾ä¸­ä»‹ç»è¿‡ï¼‰çš„ç®—å­æè¿°è½¬å˜æˆä¸€ä¸ªå¯¹åº”TensorIRå‡½æ•°çš„<code class="docutils literal notranslate"><span class="pre">call_tir</span></code>æ“ä½œï¼ˆ<code class="docutils literal notranslate"><span class="pre">call_tir</span></code>åœ¨ç¬¬å››èŠ‚è¯¾ä¸­ä»‹ç»è¿‡ï¼‰ã€‚ä¸æ‰‹å·¥å†™TensorIRå‡½æ•°ç›¸æ¯”ï¼Œå†™å¼ é‡è¡¨è¾¾å¼æè¿°å¯ä»¥ç”¨å‡ è¡Œä»£ç æ¥å®Œæˆï¼Œè¿™å‡å°‘äº†éœ€è¦çš„å·¥ä½œé‡å’ŒçŠ¯é”™çš„æ¦‚ç‡ã€‚</p>
<p><code class="docutils literal notranslate"><span class="pre">emit_te</span></code>çš„å‡½æ•°ç­¾åæ˜¯<code class="docutils literal notranslate"><span class="pre">emit_te(func,</span> <span class="pre">*input)</span></code>ï¼Œå…¶ä¸­<code class="docutils literal notranslate"><span class="pre">func</span></code>æ˜¯ä¸€ä¸ªè¿”å›å¼ é‡è¡¨è¾¾å¼çš„å‡½æ•°ï¼Œè€Œ<code class="docutils literal notranslate"><span class="pre">*input</span></code>æ˜¯<code class="docutils literal notranslate"><span class="pre">func</span></code>çš„è¾“å…¥ã€‚</p>
<p>è®©æˆ‘ä»¬ä»ä¸€ä¸ªä¾‹å­å¼€å§‹è¯¦ç»†ä»‹ç»ã€‚åœ¨ä¸‹æ–¹çš„ä»£ç å—ä¸­ï¼Œ<code class="docutils literal notranslate"><span class="pre">relu</span></code>æ˜¯ä¸€ä¸ªè¿”å›ReLUç®—å­çš„å¼ é‡è¡¨è¾¾å¼æè¿°çš„å‡½æ•°ã€‚ä¸ºäº†æ„å»ºä¸€ä¸ªæ‰§è¡Œå•ä¸ªReLUç®—å­çš„Relaxå‡½æ•°ï¼Œåœ¨<code class="docutils literal notranslate"><span class="pre">emit_te_example</span></code>ä¸­æˆ‘ä»¬é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ª<code class="docutils literal notranslate"><span class="pre">BlockBuilder</span></code>å®ä¾‹<code class="docutils literal notranslate"><span class="pre">bb</span></code>ã€‚æˆ‘ä»¬ä¹Ÿå®šä¹‰äº†ä¸€ä¸ª2ç»´128x128å¤§å°çš„å¼ é‡å˜é‡<code class="docutils literal notranslate"><span class="pre">x</span></code>ï¼Œå®ƒå°†ä½œä¸ºReLUæ“ä½œçš„è¾“å…¥å¼ é‡ï¼ˆåŒæ—¶ä¹Ÿæ˜¯Relaxå‡½æ•°çš„è¾“å…¥ï¼‰ã€‚</p>
<p>åœ¨è¿™ä¹‹åï¼Œæˆ‘ä»¬ç”¨<code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">bb.function(name,</span> <span class="pre">[*input])</span></code> APIæ„å»ºä¸€ä¸ªä»¥<code class="docutils literal notranslate"><span class="pre">x</span></code>ä¸ºè¾“å…¥çš„Relaxå‡½æ•° <code class="docutils literal notranslate"><span class="pre">main</span></code>ã€‚ç„¶åæˆ‘ä»¬æ„å»ºä¸€ä¸ªdataflow blockã€‚åœ¨è¿™ä¸ªdataflow blocké‡Œï¼Œæˆ‘ä»¬é¦–å…ˆç”¨<code class="docutils literal notranslate"><span class="pre">emit_te</span></code>ç”Ÿæˆä¸€ä¸ªè°ƒç”¨ReLUç®—å­çš„<code class="docutils literal notranslate"><span class="pre">call_tir</span></code>ã€‚è¿™é‡Œ <code class="docutils literal notranslate"><span class="pre">emit_te</span></code>åœ¨IRModuleä¸­ç”Ÿæˆäº†ä¸€ä¸ªåå­—ä¸º<code class="docutils literal notranslate"><span class="pre">relu</span></code>çš„TensorIRå‡½æ•°ï¼Œç„¶ååœ¨dataflow blockä¸­ç”Ÿæˆ<code class="docutils literal notranslate"><span class="pre">call_tir(relu,</span> <span class="pre">(x,),</span> <span class="pre">(128,</span> <span class="pre">128),</span> <span class="pre">dtype=&quot;float32&quot;)</span></code>æ“ä½œã€‚<code class="docutils literal notranslate"><span class="pre">call_tir</span></code>ä¹‹åæ˜¯å‡½æ•°è¿”å›ã€‚</p>
<p>åœ¨è¿™ä¸€æ„é€ ä¹‹åï¼ŒBlockBuilderå®ä¾‹<code class="docutils literal notranslate"><span class="pre">bb</span></code>åŒ…å«æ„å»ºå®Œçš„IRModuleï¼Œå®ƒå¯ä»¥é€šè¿‡<code class="docutils literal notranslate"><span class="pre">bb.get()</span></code>å¾—åˆ°ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">relu</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span> <span class="n">fcompute</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span> <span class="n">te</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;B&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">B</span>


<span class="k">def</span> <span class="nf">emit_te_example</span><span class="p">():</span>
    <span class="n">bb</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">BlockBuilder</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span> <span class="n">relax</span><span class="o">.</span><span class="n">DynTensorType</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">bb</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]):</span>
        <span class="k">with</span> <span class="n">bb</span><span class="o">.</span><span class="n">dataflow</span><span class="p">():</span>
            <span class="n">lv0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">emit_te</span><span class="p">(</span><span class="n">relu</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">gv</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">emit_output</span><span class="p">(</span><span class="n">lv0</span><span class="p">)</span>
        <span class="n">bb</span><span class="o">.</span><span class="n">emit_func_output</span><span class="p">(</span><span class="n">gv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bb</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>å‡½æ•°<code class="docutils literal notranslate"><span class="pre">emit_te_example</span></code>è¿”å›æ„é€ å¾—åˆ°çš„IRModuleã€‚ä¸ºäº†çœ‹çš„æ›´æ¸…æ¥šï¼Œæˆ‘ä»¬å¯ä»¥è¾“å‡ºè¿™ä¸€IRModuleã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">IPython</span>

<span class="n">mod</span> <span class="o">=</span> <span class="n">emit_te_example</span><span class="p">()</span>
<span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">Code</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">script</span><span class="p">(),</span> <span class="n">language</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>æ­£å¦‚ä½ çœ‹åˆ°çš„ï¼Œé€šè¿‡BlockBuilderç”Ÿæˆçš„IRModuleç¡®å®åŒ…å«äº†ReLUçš„TensorIRå®ç°å’Œä¸€ä¸ªå«æœ‰è°ƒç”¨ReLUå®ç°çš„<code class="docutils literal notranslate"><span class="pre">call_tir</span></code>çš„Relaxå‡½æ•°</p>
<p>ç°åœ¨è½®åˆ°ä½ æ¥ç”¨BlockBuilderå’Œ<code class="docutils literal notranslate"><span class="pre">emit_te</span></code>æ¥åˆ›å»ºä¸€ä¸ªå’Œä¹‹å‰å®šä¹‰çš„PyTorchæ¨¡å‹ç­‰ä»·çš„IRModuleã€‚ä½ å¯ä»¥è‡ªå·±ä¸ºæ‰€æœ‰çš„ç®—å­å†™å¼ é‡è¡¨è¾¾å¼æè¿°ã€‚æˆ–è€…ï¼ŒTVMæä¾›äº†TOPIï¼ˆTVM Operator Inventoryï¼‰åº“ï¼Œå®ƒä¸ºä¸åŒçš„ç®—å­æä¾›äº†å¼ é‡è¡¨è¾¾å¼æè¿°ã€‚å¦‚æœä½ æ„¿æ„é˜…è¯»<a class="reference external" href="https://tvm.apache.org/docs/reference/api/python/topi.html">æ–‡æ¡£</a>æ¥å¼„æ‡‚å®ƒçš„ç”¨æ³•ï¼Œè¿™ä¹Ÿæ˜¯è¢«é¼“åŠ±çš„ã€‚æˆ‘ä»¬æä¾›äº†æµ‹è¯•å‡½æ•°æ¥æ£€æŸ¥ä½ çš„IRModuleçš„æ­£ç¡®æ€§ã€‚</p>
<p>æ³¨æ„åˆ°æ¯ä¸ªConv2då±‚å’Œlinearå±‚éƒ½åŒ…å«äº†ä¸€ä¸ªåç½®åŠ æ³•ï¼Œè¿™åº”è¯¥åœ¨ä½ æ„å»ºçš„IRModuleä¸­è¢«ä½“ç°ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_model_via_emit_te</span><span class="p">():</span>
    <span class="n">bb</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">BlockBuilder</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">,</span> <span class="n">relax</span><span class="o">.</span><span class="n">DynTensorType</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">))</span>

    <span class="n">conv2d_weight</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">const</span><span class="p">(</span><span class="n">weight_map</span><span class="p">[</span><span class="s2">&quot;conv2d_weight&quot;</span><span class="p">],</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
    <span class="n">conv2d_bias</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">const</span><span class="p">(</span><span class="n">weight_map</span><span class="p">[</span><span class="s2">&quot;conv2d_bias&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
    <span class="n">linear0_weight</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">const</span><span class="p">(</span><span class="n">weight_map</span><span class="p">[</span><span class="s2">&quot;linear0_weight&quot;</span><span class="p">],</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
    <span class="n">linear0_bias</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">const</span><span class="p">(</span><span class="n">weight_map</span><span class="p">[</span><span class="s2">&quot;linear0_bias&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
    <span class="n">linear1_weight</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">const</span><span class="p">(</span><span class="n">weight_map</span><span class="p">[</span><span class="s2">&quot;linear1_weight&quot;</span><span class="p">],</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
    <span class="n">linear1_bias</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">const</span><span class="p">(</span><span class="n">weight_map</span><span class="p">[</span><span class="s2">&quot;linear1_bias&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">bb</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]):</span>
        <span class="k">with</span> <span class="n">bb</span><span class="o">.</span><span class="n">dataflow</span><span class="p">():</span>
           <span class="c1"># TODO</span>
           <span class="o">...</span>
        <span class="n">bb</span><span class="o">.</span><span class="n">emit_func_output</span><span class="p">(</span><span class="n">gv</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bb</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">build_mod</span><span class="p">(</span><span class="n">mod</span><span class="p">):</span>
    <span class="n">exec</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s2">&quot;llvm&quot;</span><span class="p">)</span>
    <span class="n">dev</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="n">vm</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">VirtualMachine</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vm</span>


<span class="k">def</span> <span class="nf">check_equivalence</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">torch_model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">):</span>
    <span class="n">torch_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">rt_mod</span> <span class="o">=</span> <span class="n">build_mod</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">test_loader</span><span class="p">:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">label</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="n">output_from_pytorch</span> <span class="o">=</span> <span class="n">torch_model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">output_from_relax</span> <span class="o">=</span> <span class="n">rt_mod</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">](</span><span class="n">tvm</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">tvm</span><span class="o">.</span><span class="n">cpu</span><span class="p">()))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">tvm</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">output_from_pytorch</span><span class="p">,</span> <span class="n">output_from_relax</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>


<span class="n">test_data</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">FashionMNIST</span><span class="p">(</span>
    <span class="s2">&quot;./data&quot;</span><span class="p">,</span>
    <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()])</span>
<span class="p">)</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">mod</span> <span class="o">=</span> <span class="n">create_model_via_emit_te</span><span class="p">()</span>
<span class="n">torch_model</span> <span class="o">=</span> <span class="n">pytorch_model</span><span class="p">()</span>

<span class="n">check_equivalence</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">torch_model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">)</span>
<span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">Code</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">script</span><span class="p">(),</span> <span class="n">language</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h2>ç¬¬ä¸‰éƒ¨åˆ†: ä½¿ç”¨åº“<a class="headerlink" href="#id2" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h2>
<p>æ­£å¦‚æˆ‘ä»¬åœ¨ç¬¬å››èŠ‚è¯¾ä¸­è°ˆåˆ°çš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†torchå‡½æ•°æ•´åˆè¿›IRModuleã€‚æ­¥éª¤åŒ…æ‹¬æ³¨å†Œä¸€ä¸ªå¤–éƒ¨è¿è¡Œæ—¶å‡½æ•°ï¼Œå’Œåœ¨IRModuleä¸­ç”¨<code class="docutils literal notranslate"><span class="pre">call_tir</span></code>è°ƒç”¨ã€‚</p>
<p>è¿™é‡Œæ˜¯ä¸€ä¸ªç”¨torch matmulå’Œtorch addæ‹‰åŠ›å®ç°ä¸€ä¸ªlinearå±‚çš„ä¾‹å­ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨ç¬¬å››èŠ‚è¯¾çš„ç¬”è®°ä¸­æ‰¾åˆ°è¿™ä¸ªä¾‹å­ã€‚</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@tvm</span><span class="o">.</span><span class="n">register_func</span><span class="p">(</span><span class="s2">&quot;env.linear&quot;</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">torch_linear</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">tvm</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span>
                 <span class="n">w</span><span class="p">:</span> <span class="n">tvm</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span>
                 <span class="n">b</span><span class="p">:</span> <span class="n">tvm</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span>
                 <span class="n">out</span><span class="p">:</span> <span class="n">tvm</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">NDArray</span><span class="p">):</span>
    <span class="n">x_torch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_dlpack</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">w_torch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_dlpack</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="n">b_torch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_dlpack</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">out_torch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_dlpack</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">x_torch</span><span class="p">,</span> <span class="n">w_torch</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out_torch</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">out_torch</span><span class="p">,</span> <span class="n">b_torch</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out_torch</span><span class="p">)</span>


<span class="nd">@tvm</span><span class="o">.</span><span class="n">script</span><span class="o">.</span><span class="n">ir_module</span>
<span class="k">class</span> <span class="nc">MyModuleWithExternCall</span><span class="p">:</span>
    <span class="nd">@R</span><span class="o">.</span><span class="n">function</span>
    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">784</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">),</span>
             <span class="n">w0</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">((</span><span class="mi">128</span><span class="p">,</span> <span class="mi">784</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">),</span>
             <span class="n">b0</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">((</span><span class="mi">128</span><span class="p">,),</span> <span class="s2">&quot;float32&quot;</span><span class="p">)):</span>
        <span class="c1"># block 0</span>
        <span class="k">with</span> <span class="n">R</span><span class="o">.</span><span class="n">dataflow</span><span class="p">():</span>
            <span class="n">lv0</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">call_tir</span><span class="p">(</span><span class="s2">&quot;env.linear&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">b0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
            <span class="o">...</span>
        <span class="k">return</span> <span class="o">...</span>
</pre></div>
</div>
<p>è¯·ä¸ºä½ åœ¨ç¬¬äºŒéƒ¨åˆ†ä¸­åˆ›å»ºçš„IRModuleä¸­çš„å·ç§¯å±‚æ³¨å†Œå¤–éƒ¨å‡½æ•°ã€‚ä½ éœ€è¦ä½¿ç”¨NumPyæˆ–è€…PyTorchä½œä¸ºä½ çš„å‡½æ•°å®ç°ã€‚</p>
<p>ä½ å¯èƒ½éœ€è¦ä½¿ç”¨<code class="docutils literal notranslate"><span class="pre">BlockBuilder.emit</span></code>åœ¨æ­£åœ¨æ„å»ºçš„Relaxå‡½æ•°çš„ç»“å°¾ç›´æ¥æ·»åŠ ä¸€ä¸ª<code class="docutils literal notranslate"><span class="pre">call_tir</span></code>æ“ä½œã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_model_with_torch_func</span><span class="p">():</span>
    <span class="n">bb</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">BlockBuilder</span><span class="p">()</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">,</span> <span class="n">relax</span><span class="o">.</span><span class="n">DynTensorType</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">))</span>

    <span class="n">conv2d_weight</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">const</span><span class="p">(</span><span class="n">weight_map</span><span class="p">[</span><span class="s2">&quot;conv2d_weight&quot;</span><span class="p">],</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
    <span class="n">conv2d_bias</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">const</span><span class="p">(</span><span class="n">weight_map</span><span class="p">[</span><span class="s2">&quot;conv2d_bias&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
    <span class="n">linear0_weight</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">const</span><span class="p">(</span><span class="n">weight_map</span><span class="p">[</span><span class="s2">&quot;linear0_weight&quot;</span><span class="p">],</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
    <span class="n">linear0_bias</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">const</span><span class="p">(</span><span class="n">weight_map</span><span class="p">[</span><span class="s2">&quot;linear0_bias&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
    <span class="n">linear1_weight</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">const</span><span class="p">(</span><span class="n">weight_map</span><span class="p">[</span><span class="s2">&quot;linear1_weight&quot;</span><span class="p">],</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
    <span class="n">linear1_bias</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">const</span><span class="p">(</span><span class="n">weight_map</span><span class="p">[</span><span class="s2">&quot;linear1_bias&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">bb</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]):</span>
        <span class="k">with</span> <span class="n">bb</span><span class="o">.</span><span class="n">dataflow</span><span class="p">():</span>
            <span class="c1"># TODO:</span>
            <span class="o">...</span>
        <span class="n">bb</span><span class="o">.</span><span class="n">emit_func_output</span><span class="p">(</span><span class="n">gv</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bb</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>


<span class="n">test_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">mod</span> <span class="o">=</span> <span class="n">create_model_with_torch_func</span><span class="p">()</span>
<span class="n">check_equivalence</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">torch_model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h2>ç¬¬å››éƒ¨åˆ†: ç«¯åˆ°ç«¯æ¨¡å‹ä¸­çš„ç¨‹åºå˜æ¢<a class="headerlink" href="#id3" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h2>
<p>åœ¨TensorIRç»ƒä¹ ä¸­, æˆ‘ä»¬å­¦ä¼šäº†å¦‚ä½•å˜æ¢å•ä¸ªTensorIRå‡½æ•°ã€‚åœ¨ç«¯åˆ°ç«¯æ¨¡å‹ä¸­å˜æ¢æ˜¯ç±»ä¼¼çš„ã€‚</p>
<p>å’Œæ‰¹é‡çŸ©é˜µä¹˜æ³•ç›¸æ¯”ï¼Œè®©æˆ‘ä»¬å…³æ³¨ä¸€ä¸ªæ›´åŠ æœ‰æŒ‘æˆ˜æ€§çš„ç®—å­ï¼šconv2dï¼ˆäºŒç»´å·ç§¯ï¼‰ã€‚</p>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬ä»‹ç»ä¸€äº›æ–°çš„åŸè¯­ï¼š</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">compute_inline</span></code>ï¼šå®ƒå°†ä¸€ä¸ªblockå†…è”åˆ°å¦ä¸€ä¸ªblockä¸­ï¼Œä»¥å‡å°‘å†…å­˜ä½¿ç”¨å¤§å°å’Œå†…å­˜è®¿é—®æ¬¡æ•°</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fuse</span></code>ï¼šå’Œ<code class="docutils literal notranslate"><span class="pre">split</span></code>ç›¸å¯¹ã€‚èåˆå¤šä¸ªè½´ã€‚è¿™é‡Œ<code class="docutils literal notranslate"><span class="pre">fuse</span></code>ä¸<code class="docutils literal notranslate"><span class="pre">parallel</span></code> / <code class="docutils literal notranslate"><span class="pre">vectorize</span></code> / <code class="docutils literal notranslate"><span class="pre">unroll</span></code>ä¸€èµ·ä½¿ç”¨ï¼Œä»¥å¢åŠ å¹¶è¡Œåº¦ã€‚</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@T</span><span class="o">.</span><span class="n">prim_func</span>
<span class="k">def</span> <span class="nf">before_inline</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">handle</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">handle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">match_buffer</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">alloc_buffer</span><span class="p">((</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">match_buffer</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">):</span>
            <span class="n">vi</span><span class="p">,</span> <span class="n">vj</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="s2">&quot;SS&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
            <span class="n">B</span><span class="p">[</span><span class="n">vi</span><span class="p">,</span> <span class="n">vj</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">vi</span><span class="p">,</span> <span class="n">vj</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">):</span>
            <span class="n">vi</span><span class="p">,</span> <span class="n">vj</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="s2">&quot;SS&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
            <span class="n">C</span><span class="p">[</span><span class="n">vi</span><span class="p">,</span> <span class="n">vj</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">vi</span><span class="p">,</span> <span class="n">vj</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span>


<span class="n">sch</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">tir</span><span class="o">.</span><span class="n">Schedule</span><span class="p">(</span><span class="n">before_inline</span><span class="p">)</span>
<span class="n">sch</span><span class="o">.</span><span class="n">compute_inline</span><span class="p">(</span><span class="n">sch</span><span class="o">.</span><span class="n">get_block</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">))</span>
<span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">Code</span><span class="p">(</span><span class="n">sch</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">script</span><span class="p">(),</span> <span class="n">language</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@T</span><span class="o">.</span><span class="n">prim_func</span>
<span class="k">def</span> <span class="nf">before_fuse</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">handle</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">handle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">match_buffer</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">match_buffer</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">):</span>
            <span class="n">vi</span><span class="p">,</span> <span class="n">vj</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="s2">&quot;SS&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
            <span class="n">B</span><span class="p">[</span><span class="n">vi</span><span class="p">,</span> <span class="n">vj</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">vi</span><span class="p">,</span> <span class="n">vj</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span>


<span class="n">sch</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">tir</span><span class="o">.</span><span class="n">Schedule</span><span class="p">(</span><span class="n">before_fuse</span><span class="p">)</span>
<span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">sch</span><span class="o">.</span><span class="n">get_loops</span><span class="p">(</span><span class="n">sch</span><span class="o">.</span><span class="n">get_block</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">))</span>
<span class="n">sch</span><span class="o">.</span><span class="n">fuse</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
<span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">Code</span><span class="p">(</span><span class="n">sch</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">script</span><span class="p">(),</span> <span class="n">language</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>ç°åœ¨æˆ‘ä»¬é¦–å…ˆä¸ºç¬¬äºŒéƒ¨åˆ†ä¸­å¾—åˆ°çš„IRModuleåˆ›å»ºä¸€ä¸ªscheduleï¼Œç„¶åå¯¹å…¶ä¸­çš„conv2d TensorIRå‡½æ•°å˜æ¢ã€‚å’ŒTensorIRç»ƒä¹ ç±»ä¼¼ï¼Œæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªç›®æ ‡å‡½æ•°ã€‚ä½†è¯·æ³¨æ„ï¼Œç›®æ ‡å‡½æ•°ä¸æ˜¯æ ‡å‡†ç­”æ¡ˆï¼ŒåŸå› å¦‚ä¸‹ï¼š</p>
<ul class="simple">
<li><p>å®ƒå¯èƒ½ä¸èƒ½åœ¨æ‰€æœ‰ç¡¬ä»¶ä¸­éƒ½å–å¾—æœ€ä½³æ€§èƒ½</p></li>
<li><p>åŸå§‹çš„conv2d TensorIRå®ç°å¯èƒ½ä¸åŒï¼Œè¿™å†³å®šä¸ä½ åœ¨ç¬¬äºŒéƒ¨åˆ†ä¸­ä½¿ç”¨çš„å¼ é‡è¡¨è¾¾å¼æè¿°ï¼š</p>
<ul>
<li><p>å¦‚æœä½ å°†conv2dçš„è®¡ç®—å’Œåç½®åŠ æ³•çš„è®¡ç®—æ”¾åœ¨äº†ä¸€ä¸ªå¼ é‡è¡¨è¾¾å¼ä¸­ï¼Œé‚£ä¹ˆåœ¨å˜æ¢å®Œæˆçš„TensorIRå‡½æ•°çš„æœ«å°¾åº”è¯¥æœ‰ä¸€ä¸ªè®¡ç®—åç½®åŠ æ³•çš„block</p></li>
<li><p>å¦‚æœä½ å°†ä¸Šè¿°ä¸¤ä¸ªè®¡ç®—åˆ†å¼€åœ¨ä¸åŒçš„å¼ é‡è¡¨è¾¾å¼ï¼Œæˆ–è€…ä½ ä½¿ç”¨äº†TOPIæä¾›çš„conv2dï¼Œé‚£ä¹ˆå˜æ¢å®Œæˆçš„TensorIRå‡½æ•°æœ«å°¾ä¸åº”è¯¥æœ‰è®¡ç®—åç½®åŠ æ³•çš„blockã€‚ä¸‹é¢ç»™å‡ºçš„ç›®æ ‡å‡½æ•°æ˜¯ç”¨TOPI conv2dè·å¾—çš„TensorIRå‡½æ•°åšå˜æ¢åç”Ÿæˆçš„ã€‚</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@T</span><span class="o">.</span><span class="n">prim_func</span>
<span class="k">def</span> <span class="nf">target_func</span><span class="p">(</span><span class="n">rxplaceholder</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">Buffer</span><span class="p">[(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">],</span> <span class="n">rxplaceholder_1</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">Buffer</span><span class="p">[(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">],</span> <span class="n">conv2d_nchw</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">Buffer</span><span class="p">[(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">26</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">T</span><span class="o">.</span><span class="n">func_attr</span><span class="p">({</span><span class="s2">&quot;global_symbol&quot;</span><span class="p">:</span> <span class="s2">&quot;conv2d&quot;</span><span class="p">,</span> <span class="s2">&quot;tir.noalias&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
    <span class="c1"># body</span>
    <span class="c1"># with T.block(&quot;root&quot;)</span>
    <span class="k">for</span> <span class="n">i0_0_i1_0_i2_0_i3_0_fused</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">parallel</span><span class="p">(</span><span class="mi">2704</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i0_1_i1_1_fused_init</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">unroll</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i2_1_i3_1_fused_init</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">vectorized</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="s2">&quot;conv2d_nchw_init&quot;</span><span class="p">):</span>
                    <span class="n">nn</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">spatial</span><span class="p">(</span>
                        <span class="mi">4</span><span class="p">,</span> <span class="n">i0_0_i1_0_i2_0_i3_0_fused</span> <span class="o">//</span> <span class="mi">1352</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i0_1_i1_1_fused_init</span> <span class="o">//</span> <span class="mi">4</span><span class="p">)</span>
                    <span class="n">ff</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">spatial</span><span class="p">(</span>
                        <span class="mi">32</span><span class="p">,</span> <span class="n">i0_0_i1_0_i2_0_i3_0_fused</span> <span class="o">%</span> <span class="mi">1352</span> <span class="o">//</span> <span class="mi">169</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">i0_1_i1_1_fused_init</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span>
                    <span class="n">yy</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">spatial</span><span class="p">(</span>
                        <span class="mi">26</span><span class="p">,</span> <span class="n">i0_0_i1_0_i2_0_i3_0_fused</span> <span class="o">%</span> <span class="mi">169</span> <span class="o">//</span> <span class="mi">13</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i2_1_i3_1_fused_init</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">xx</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">spatial</span><span class="p">(</span>
                        <span class="mi">26</span><span class="p">,</span> <span class="n">i0_0_i1_0_i2_0_i3_0_fused</span> <span class="o">%</span> <span class="mi">13</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i2_1_i3_1_fused_init</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">T</span><span class="o">.</span><span class="n">reads</span><span class="p">()</span>
                    <span class="n">T</span><span class="o">.</span><span class="n">writes</span><span class="p">(</span><span class="n">conv2d_nchw</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">])</span>
                    <span class="n">conv2d_nchw</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i4</span><span class="p">,</span> <span class="n">i5</span><span class="p">,</span> <span class="n">i6</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i0_1_i1_1_fused</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">unroll</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i2_1_i3_1_fused</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">vectorized</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="s2">&quot;conv2d_nchw_update&quot;</span><span class="p">):</span>
                        <span class="n">nn</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">spatial</span><span class="p">(</span>
                            <span class="mi">4</span><span class="p">,</span> <span class="n">i0_0_i1_0_i2_0_i3_0_fused</span> <span class="o">//</span> <span class="mi">1352</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i0_1_i1_1_fused</span> <span class="o">//</span> <span class="mi">4</span><span class="p">)</span>
                        <span class="n">ff</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">spatial</span><span class="p">(</span>
                            <span class="mi">32</span><span class="p">,</span> <span class="n">i0_0_i1_0_i2_0_i3_0_fused</span> <span class="o">%</span> <span class="mi">1352</span> <span class="o">//</span> <span class="mi">169</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">i0_1_i1_1_fused</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span>
                        <span class="n">yy</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">spatial</span><span class="p">(</span>
                            <span class="mi">26</span><span class="p">,</span> <span class="n">i0_0_i1_0_i2_0_i3_0_fused</span> <span class="o">%</span> <span class="mi">169</span> <span class="o">//</span> <span class="mi">13</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i2_1_i3_1_fused</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">xx</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">spatial</span><span class="p">(</span>
                            <span class="mi">26</span><span class="p">,</span> <span class="n">i0_0_i1_0_i2_0_i3_0_fused</span> <span class="o">%</span> <span class="mi">13</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i2_1_i3_1_fused</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">rc</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rx</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="s2">&quot;RRR&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">i4</span><span class="p">,</span> <span class="n">i5</span><span class="p">,</span> <span class="n">i6</span><span class="p">])</span>
                        <span class="n">T</span><span class="o">.</span><span class="n">reads</span><span class="p">(</span><span class="n">conv2d_nchw</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">],</span> <span class="n">rxplaceholder</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span>
                                <span class="n">rc</span><span class="p">,</span> <span class="n">yy</span> <span class="o">+</span> <span class="n">ry</span><span class="p">,</span> <span class="n">xx</span> <span class="o">+</span> <span class="n">rx</span><span class="p">],</span> <span class="n">rxplaceholder_1</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rx</span><span class="p">])</span>
                        <span class="n">T</span><span class="o">.</span><span class="n">writes</span><span class="p">(</span><span class="n">conv2d_nchw</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">])</span>
                        <span class="n">conv2d_nchw</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv2d_nchw</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">]</span> <span class="o">+</span> \
                            <span class="n">rxplaceholder</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">yy</span> <span class="o">+</span> <span class="n">ry</span><span class="p">,</span> <span class="n">xx</span> <span class="o">+</span>
                                          <span class="n">rx</span><span class="p">]</span> <span class="o">*</span> <span class="n">rxplaceholder_1</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rx</span><span class="p">]</span>
</pre></div>
</div>
<p>å’ŒTensorIRç»ƒä¹ ä¸­ä¸åŒçš„æ˜¯, è¿™é‡Œscheduleæ˜¯ä¸ºä¸€ä¸ªIRModuleåˆ›å»ºçš„ï¼Œè€Œä¸æ˜¯TensorIRå‡½æ•°. å› æ­¤ï¼Œå½“ä½¿ç”¨<code class="docutils literal notranslate"><span class="pre">sch.get_block</span></code>æ—¶ï¼Œéœ€è¦æä¾›TensorIRå‡½æ•°åå­—ï¼Œå¦‚ä¸‹æ–¹æ‰€ç¤ºã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mod</span> <span class="o">=</span> <span class="n">create_model_via_emit_te</span><span class="p">()</span>
<span class="n">sch</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">tir</span><span class="o">.</span><span class="n">Schedule</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>

<span class="c1"># Step 1. Get blocks</span>
<span class="c1"># block = sch.get_block(name=&quot;your_block_name&quot;, func_name=&quot;your_function_name&quot;)</span>

<span class="c1"># Step 2. Inline the padding block (if exists)</span>

<span class="c1"># Step 3. Get loops</span>

<span class="c1"># Step 4. Organize the loops</span>

<span class="c1"># Step 5. decompose reduction</span>

<span class="c1"># Step 6. fuse + vectorize / fuse + parallel / fuse + unroll</span>

<span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">Code</span><span class="p">(</span><span class="n">sch</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">script</span><span class="p">(),</span> <span class="n">language</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>åŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥æµ‹è¯•å˜æ¢åIRModuleçš„æ­£ç¡®æ€§ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">check_equivalence</span><span class="p">(</span><span class="n">sch</span><span class="o">.</span><span class="n">mod</span><span class="p">,</span> <span class="n">torch_model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "daobook/mlcbook",
            ref: "xin",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./assignment"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="index.html" title="ä¸Šä¸€é¡µ é¡µ">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">ä¸Šä¸€é¡µ</p>
            <p class="prev-next-title">ç´¢å¼•å’Œè¡¨æ ¼</p>
        </div>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
      &copy; Copyright .<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>